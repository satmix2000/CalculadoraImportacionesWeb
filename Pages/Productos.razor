@page "/"
@namespace CalculadoraImportacionesWeb.Pages
@using CalculadoraImportacionesWeb.Models
@using CalculadoraImportacionesWeb.Services
@using CalculadoraImportacionesWeb.Data
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject ICalculadoraService Calculadora

<h3>Calculadora de Importaciones</h3>

<button @onclick="AgregarProducto" class="btn btn-primary mb-3">Nuevo Producto</button>

@if (productos.Count == 0)
{
    <div class="alert alert-info">
        No hay productos. Haz clic en "Nuevo Producto" para agregar uno.
    </div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Descripción</th>
                <th>FOB (¥)</th>
                <th>Cantidad</th>
                <th>Costo (USD)</th>
                <th>Precio Venta (ARS)</th>
                <th>Ganancia</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var producto in productos)
            {
                <tr>
                    <td>@producto.Descripcion</td>
                    <td>
                        <input type="number" step="0.01" 
                               @bind="producto.ValorFOBYuan" 
                               @bind:event="oninput"
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="number" 
                               @bind="producto.Cantidad" 
                               @bind:event="oninput"
                               class="form-control form-control-sm" />
                    </td>
                    <td>$@producto.CostoTotal.ToString("N2")</td>
                    <td>$@producto.PrecioVentaARS.ToString("N2")</td>
                    <td>@producto.PorcentajeGanancia.ToString("N1")%</td>
                    <td>
                        <button @onclick="@(() => EliminarProducto(producto))" 
                                class="btn btn-sm btn-danger">Eliminar</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<div class="card mt-4">
    <div class="card-header">
        <h5>Resumen</h5>
    </div>
    <div class="card-body">
        <p>Total Productos: @productos.Count</p>
        <p>Costo Total USD: $@productos.Sum(p => p.CostoTotal).ToString("N2")</p>
        <p>Valor Total ARS: $@productos.Sum(p => p.PrecioVentaARS).ToString("N2")</p>
    </div>
</div>

@code {
    private List<Producto> productos = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarProductos();
    }

    private async Task CargarProductos()
    {
        try
        {
            productos = await Db.Productos.ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar productos: {ex.Message}");
        }
    }

    private async Task AgregarProducto()
    {
        var nuevoProducto = new Producto
        {
            Descripcion = "Nuevo Producto",
            ValorFOBYuan = 1000,
            PesoUnitario = 1,
            Cantidad = 1,
            PorcentajeArancelAduana = 0.30m,
            PorcentajeArancelEstadisticas = 0.025m,
            IVA = 0.21m
        };

        await RecalcularProducto(nuevoProducto);
        Db.Productos.Add(nuevoProducto);
        await Db.SaveChangesAsync();
        await CargarProductos();
    }

    private async Task RecalcularProducto(Producto producto)
    {
        try
        {
            await Calculadora.CalcularProductoAsync(producto);
            Db.Productos.Update(producto);
            await Db.SaveChangesAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al recalcular: {ex.Message}");
        }
    }

    private async Task EliminarProducto(Producto producto)
    {
        Db.Productos.Remove(producto);
        await Db.SaveChangesAsync();
        await CargarProductos();
    }
}
