@page "/"
@using CalculadoraImportacionesWeb.Models
@using CalculadoraImportacionesWeb.Services
@using CalculadoraImportacionesWeb.Data
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject ICalculadoraService Calculadora

<h1>Calculadora de Importaciones</h1>

<p>Estado: <strong class="text-success">Funcionando ✅</strong></p>

<div class="card mt-4">
    <div class="card-header">
        <h5>Productos</h5>
    </div>
    <div class="card-body">
        <p>Total de productos en la base de datos: @productos.Count</p>
        
        <button @onclick="AgregarProductoEjemplo" class="btn btn-primary">
            Agregar producto de ejemplo
        </button>
        
        <button @onclick="ListarProductos" class="btn btn-secondary">
            Refrescar lista
        </button>
    </div>
</div>

@if (productos.Any())
{
    <div class="card mt-4">
        <div class="card-header">
            <h5>Lista de Productos</h5>
        </div>
        <div class="card-body">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Descripción</th>
                        <th>FOB (¥)</th>
                        <th>Cantidad</th>
                        <th>Costo Total (USD)</th>
                        <th>Precio Venta (ARS)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var prod in productos)
                    {
                        <tr>
                            <td>@prod.ID</td>
                            <td>@prod.Descripcion</td>
                            <td>@prod.ValorFOBYuan.ToString("N2")</td>
                            <td>@prod.Cantidad</td>
                            <td>@prod.CostoTotal.ToString("N2")</td>
                            <td>@prod.PrecioVentaARS.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    private List<Producto> productos = new List<Producto>();
    
    protected override async Task OnInitializedAsync()
    {
        await CargarProductos();
    }
    
    private async Task CargarProductos()
    {
        productos = await Db.Productos.ToListAsync();
    }
    
    private async Task AgregarProductoEjemplo()
    {
        var producto = new Producto
        {
            Descripcion = "Producto de ejemplo " + DateTime.Now.ToString("HH:mm:ss"),
            ValorFOBYuan = 1000.50m,
            PesoUnitario = 2.5m,
            Cantidad = 10,
            PorcentajeArancelAduana = 0.30m,
            PorcentajeArancelEstadisticas = 0.025m,
            IVA = 0.21m,
            FechaIngreso = DateTime.Now
        };
        
        // Calcular los campos
        await Calculadora.CalcularProductoAsync(producto);
        
        // Guardar en BD
        Db.Productos.Add(producto);
        await Db.SaveChangesAsync();
        
        // Recargar lista
        await CargarProductos();
        
        Console.WriteLine("✅ Producto agregado y calculado.");
    }
    
    private async Task ListarProductos()
    {
        await CargarProductos();
        Console.WriteLine("✅ Lista de productos actualizada.");
    }
}
