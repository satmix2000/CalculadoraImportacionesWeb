@page "/ajustes"
@using CalculadoraImportacionesWeb.Models
@using CalculadoraImportacionesWeb.Data
@inject AppDbContext Db

<h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>

<p class="lead">Aqu√≠ puedes configurar los porcentajes y tasas de la calculadora.</p>

@if (ajustes == null)
{
    <p>Cargando ajustes...</p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Tasas de Cambio</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">USD ‚Üí ARS</label>
                        <input type="number" step="0.01" class="form-control" 
                               @bind="ajustes.TasaUSDARS" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">CNY ‚Üí USD</label>
                        <input type="number" step="0.0001" class="form-control" 
                               @bind="ajustes.TasaCNYUSD" />
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Porcentajes</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Arancel Aduana (@(ajustes.PorcentajeArancelAduana * 100)%)</label>
                        <input type="range" class="form-range" min="0" max="100" step="0.5"
                               @bind="ajustes.PorcentajeArancelAduana" 
                               @bind:format="P2" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IVA (@(ajustes.IVA * 100)%)</label>
                        <input type="range" class="form-range" min="0" max="100" step="0.5"
                               @bind="ajustes.IVA" @bind:format="P2" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-primary" @onclick="GuardarAjustes">
            üíæ Guardar Cambios
        </button>
        <button class="btn btn-secondary" @onclick="RestaurarValores">
            ‚Ü©Ô∏è Restaurar Valores por Defecto
        </button>
    </div>
}

@code {
    private Ajustes? ajustes;

    protected override async Task OnInitializedAsync()
    {
        ajustes = await Db.Ajustes.FirstOrDefaultAsync();
        if (ajustes == null)
        {
            ajustes = new Ajustes();
            Db.Ajustes.Add(ajustes);
            await Db.SaveChangesAsync();
        }
    }

    private async Task GuardarAjustes()
    {
        if (ajustes != null)
        {
            ajustes.UltimaActualizacion = DateTime.Now;
            ajustes.ActualizadoPor = "Usuario";
            await Db.SaveChangesAsync();
            Console.WriteLine("‚úÖ Ajustes guardados");
        }
    }

    private async Task RestaurarValores()
    {
        if (ajustes != null)
        {
            ajustes.TasaUSDARS = 1025.50m;
            ajustes.TasaCNYUSD = 0.1388m;
            ajustes.PorcentajeArancelAduana = 0.30m;
            ajustes.PorcentajeArancelEstadisticas = 0.025m;
            ajustes.IVA = 0.21m;
            ajustes.MargenGananciaDeseado = 0.35m;
            await GuardarAjustes();
        }
    }
}
